<?xml version="1.0"?>

<project name="freeguide-tv-build" default="build-all">

	<import file="build-plugins-info.xml"/>
	
    <target name="build-all" depends="build-plugins, build-app"/>

    <target name="build-common">
        <mkdir dir="${build}/classes/common"/>
        <!-- compile all the .java files -->
        <javac srcdir="${src}/java-common"
            destdir="${build}/classes/common"
            deprecation="on" 
            source="1.4" 
            target="1.4"
            debug="yes"
            encoding="UTF-8">
            <classpath>
                <fileset dir="${src}/lib" includes="**/*.jar"/>
            </classpath>
          </javac>
        <copy todir="${build}/classes/common">
            <fileset dir="${src}/java-common" excludes="**/*.java" />
        </copy>

    	<mkdir dir="${build}/package/${application-id}/lib"/>
		<jar jarfile="${build}/package/${application-id}/lib/common.jar" basedir="${build}/classes/common"/>
        <copy todir="${build}/package/${application-id}/lib">
            <fileset dir="${src}/lib" includes="**/*.jar"/>
        </copy>
    </target>
    
    <target name="build-plugins">
        <antcall target="all-plugins">
            <param name="actual-target" value="subtask-build-one-plugin"/>
        </antcall>
    </target>    
    
    <target name="subtask-build-one-plugin" depends="build-common">
        <mkdir dir="${build}/classes/${plugin-id}"/>
        <!-- compile all the .java files -->
        <javac srcdir="${src}/plugins/${plugin-id}/java"
            destdir="${build}/classes/${plugin-id}"
            deprecation="on" 
            source="1.4" 
            target="1.4"
            debug="yes"
            encoding="UTF-8">
            <classpath>
                <fileset dir="${src}/lib" includes="**/*.jar"/>
                <pathelement location="${build}/classes/common"/>
            </classpath>
          </javac>

        <copy todir="${build}/classes/${plugin-id}">
            <fileset dir="${src}/plugins/${plugin-id}/java" excludes="**/*.java" />
        </copy>

    	<mkdir dir="${build}/package/${plugin-id}/lib"/>
        <jar jarfile="${build}/package/${plugin-id}/lib/${plugin-id}.jar"
             basedir="${build}/classes/${plugin-id}"/>
    	
    	<copy todir="${build}/package/${plugin-id}" failonerror="false">
            <fileset dir="${src}/plugins/${plugin-id}/files"/>
            <fileset dir="${src}/plugins/${plugin-id}/files-nosrc"/>
  		</copy>
    </target>
    
    <target name="build-app" description="compile application" depends="build-common, build-startup">
        <mkdir dir="${build}/classes/${application-id}"/>
        <!-- compile all the .java files -->
        <javac srcdir="${src}/java"
            destdir="${build}/classes/${application-id}"
            deprecation="on" 
            source="1.4" 
            target="1.4"
            debug="yes"
            encoding="UTF-8">
            <classpath>
                <fileset dir="${src}/lib" includes="**/*.jar"/>
                <pathelement location="${build}/classes/common"/>
            </classpath>
          </javac>

        <copy todir="${build}/classes/${application-id}">
            <fileset dir="${src}/resources"/>
            <fileset dir="${src}/java" excludes="**/*.java"/>
        </copy>
        
        <!-- Make the jar file -->
    	<mkdir dir="${build}/package/${application-id}/lib"/>
        <jar jarfile="${build}/package/${application-id}/lib/${application-id}.jar"
             basedir="${build}/classes/${application-id}"/>

    	<mkdir dir="${build}/package/${application-id}/doc"/>
        <copy todir="${build}/package/${application-id}/doc">
            <fileset dir="doc" includes="*.html, *.css, *.txt, *.png, COPYING, TODO"/>
        </copy>
        <!-- gzip the man page -->
        <gzip src="${build}/dist/linux/freeguide.1" zipfile="${build}/package/${application-id}/freeguide.1.gz" />
    </target>
    
    <target name="build-startup" depends="build-common">
        <mkdir dir="${build}/classes/startup"/>
        <!-- compile all the .java files -->
        <javac srcdir="${src}/startup/java"
            destdir="${build}/classes/startup"
            deprecation="on" 
            source="1.3" 
            target="1.1"
            debug="yes"
            encoding="UTF-8">
          </javac>

    	<mkdir dir="${build}/package/${application-id}/lib"/>
        <jar jarfile="${build}/package/${application-id}/startup.jar"
             basedir="${build}/classes/startup"
             manifest="${src}/startup/META-INF/startup.mf" />
    </target>
</project>

