Index: MANIFEST
===================================================================
RCS file: /cvsroot/xmltv/xmltv/MANIFEST,v
retrieving revision 1.87
diff -u -B -b -w -r1.87 MANIFEST
--- MANIFEST	1 Feb 2004 21:40:45 -0000	1.87
+++ MANIFEST	4 Feb 2004 17:47:15 -0000
@@ -4,8 +4,14 @@
 Uninstall.pm
 README
 lib/Ask.pm
-lib/AskTerm.pm
-lib/AskTk.pm
+lib/Ask/GDialog.pm
+lib/Ask/Term.pm
+lib/Ask/Tk.pm
+lib/ProgressBar.pm
+lib/ProgressBar/GDialog.pm
+lib/ProgressBar/None.pm
+lib/ProgressBar/Term.pm
+lib/ProgressBar/Tk.pm
 lib/XMLTV.pm.PL
 lib/XMLTV.pm.in
 lib/TZ.pm
Index: Makefile.PL
===================================================================
RCS file: /cvsroot/xmltv/xmltv/Makefile.PL,v
retrieving revision 1.180
diff -u -B -b -w -r1.180 Makefile.PL
--- Makefile.PL	1 Feb 2004 21:42:30 -0000	1.180
+++ Makefile.PL	4 Feb 2004 17:47:16 -0000
@@ -107,9 +107,16 @@
      'lib/Usage.pm'               => '$(INST_LIBDIR)/XMLTV/Usage.pm',
      'lib/Date.pm'                => '$(INST_LIBDIR)/XMLTV/Date.pm',
      'lib/Version.pm'             => '$(INST_LIBDIR)/XMLTV/Version.pm',
+     'lib/GUI.pm'                 => '$(INST_LIBDIR)/XMLTV/GUI.pm',
      'lib/Ask.pm'                 => '$(INST_LIBDIR)/XMLTV/Ask.pm',
-     'lib/AskTk.pm'               => '$(INST_LIBDIR)/XMLTV/AskTk.pm',
-     'lib/AskTerm.pm'             => '$(INST_LIBDIR)/XMLTV/AskTerm.pm',
+     'lib/Ask/GDialog.pm'         => '$(INST_LIBDIR)/XMLTV/Ask/GDialog.pm',
+     'lib/Ask/Term.pm'            => '$(INST_LIBDIR)/XMLTV/Ask/Term.pm',
+     'lib/Ask/Tk.pm'              => '$(INST_LIBDIR)/XMLTV/Ask/Tk.pm',
+     'lib/ProgressBar.pm'         => '$(INST_LIBDIR)/XMLTV/ProgressBar.pm',
+     'lib/ProgressBar/GDialog.pm' => '$(INST_LIBDIR)/XMLTV/ProgressBar/GDialog.pm',
+     'lib/ProgressBar/None.pm'    => '$(INST_LIBDIR)/XMLTV/ProgressBar/None.pm',
+     'lib/ProgressBar/Term.pm'    => '$(INST_LIBDIR)/XMLTV/ProgressBar/Term.pm',
+     'lib/ProgressBar/Tk.pm'      => '$(INST_LIBDIR)/XMLTV/ProgressBar/Tk.pm',
      'lib/Summarize.pm'           => '$(INST_LIBDIR)/XMLTV/Summarize.pm',
      'lib/IMDB.pm'                => '$(INST_LIBDIR)/XMLTV/IMDB.pm',
      'lib/Gunzip.pm'              => '$(INST_LIBDIR)/XMLTV/Gunzip.pm',
@@ -179,8 +186,8 @@
     *ask = sub { print "$_[0] yes\n"; 1 };
 }
 else {
-    do 'lib/AskTerm.pm' or die 'could not load lib/AskTerm.pm, aborting';
-    *ask = \&XMLTV::AskTerm::askBooleanQuestion;
+    do 'lib/Ask/Term.pm' or die 'could not load lib/Ask/Term.pm, aborting';
+    *ask = \&XMLTV::Ask::Term::askBooleanQuestion;
 }
 
 # Weird shit happens when you change things like PREFIX without
@@ -194,7 +201,7 @@
 
 END
   ;
-    if (! ask("Do you wish to continue anyway?", 0)) {
+    if (! ask(0, "Do you wish to continue anyway?", 0)) {
 	exit(1);
     }
 }
@@ -386,7 +393,7 @@
 		  "\n");
 }
 print STDERR "\n";
-if (not ask('Do you want to proceed with this configuration?', 1)) {
+if (not ask(0,'Do you want to proceed with this configuration?', 1)) {
     # Need to set {install} for each component by prompting.
     foreach my $info (@opt_components) {
 	my $missing = $info->{missing};
@@ -416,7 +423,7 @@
 	else { die }
 	
 	$info->{install} =
-	  ask($msg, not $missing);
+	  ask(0, $msg, not $missing);
     }
 }
 
Index: grab/dk/tv_grab_dk
===================================================================
RCS file: /cvsroot/xmltv/xmltv/grab/dk/tv_grab_dk,v
retrieving revision 1.12
diff -u -B -b -w -r1.12 tv_grab_dk
--- grab/dk/tv_grab_dk	10 Jan 2004 10:47:08 -0000	1.12
+++ grab/dk/tv_grab_dk	4 Feb 2004 17:47:16 -0000
@@ -10,7 +10,7 @@
 
 tv_grab_dk --help
 
-tv_grab_dk [--config-file FILE] --configure
+tv_grab_dk [--config-file FILE] --configure [--gui OPTION]
 
 tv_grab_dk [--config-file FILE] [--output FILE] [--days N]
            [--offset N] [--quiet]
@@ -32,6 +32,11 @@
 default is B<~/.xmltv/tv_grab_dk.conf>.  This is the file written by
 B<--configure> and read when grabbing.
 
+B<--gui OPTION> Use this option to enable a graphical interface to be used.
+OPTION may be 'Tk' or 'GDialog', or left blank for the best available choice.
+Additional allowed values of OPTION are 'Term' for normal terminal output
+(default) and 'TermNoProgressBar' to disable the use of Term::ProgressBar.
+
 B<--output FILE> write to FILE rather than standard output.
 
 B<--days N> grab N days.  The default is one week.
@@ -79,6 +84,8 @@
 
 use XMLTV;
 use XMLTV::Memoize;
+use XMLTV::GUI;
+use XMLTV::ProgressBar;
 use XMLTV::Ask;
 use XMLTV::Mode;
 use XMLTV::Config_file;
@@ -109,8 +116,7 @@
     }
 }
 
-# Use Term::ProgressBar if installed.
-use constant Have_bar => eval { require Term::ProgressBar; 1 };
+
 
 # Whether zero-length programmes should be included in the output.
 my $WRITE_ZERO_LENGTH = 0;
@@ -130,8 +136,8 @@
 # Get options
 XMLTV::Memoize::check_argv('XMLTV::Get_nice::get_nice_aux');
 my ($opt_days, $opt_offset, $opt_help, $opt_output,
-    $opt_configure, $opt_config_file, $opt_quiet,
-    $opt_list_channels);
+    $opt_configure, $opt_config_file, $opt_gui,
+    $opt_quiet, $opt_list_channels);
 $opt_days   = 7; # default
 $opt_offset = 0; # default
 GetOptions('days=i'        => \$opt_days,
@@ -139,6 +145,7 @@
 	   'help'          => \$opt_help,
 	   'configure'     => \$opt_configure,
 	   'config-file=s' => \$opt_config_file,
+           'gui:s'         => \$opt_gui,
 	   'output=s'      => \$opt_output,
 	   'quiet'         => \$opt_quiet,
 	   'list-channels' => \$opt_list_channels,
@@ -148,6 +155,12 @@
   if (defined $opt_days && $opt_days < 0);
 usage(1) if $opt_help;
 
+# Ask the XMLTV::GUI module for the graphics type we will use  
+my $gui_type = XMLTV::GUI::get_gui_type($opt_gui);
+
+XMLTV::Ask::init($gui_type);
+XMLTV::ProgressBar::init($gui_type);
+
 my $mode = XMLTV::Mode::mode('grab', # default
 			     $opt_configure => 'configure',
 			     $opt_list_channels => 'list-channels',
@@ -161,11 +174,11 @@
     XMLTV::Config_file::check_no_overwrite($config_file);
     open(CONF, ">$config_file") or die "cannot write to $config_file: $!";
     # find list of available channels
-    my $bar = new Term::ProgressBar('getting list of channels', 1)
-      if Have_bar && not $opt_quiet;
+    my $bar = new XMLTV::ProgressBar('getting list of channels', 1)
+      if not $opt_quiet;
     my %channels = get_channels();
     die 'no channels could be found' if (scalar(keys(%channels)) == 0);
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
 
     # Ask about each channel.
     my @chs = sort keys %channels;
@@ -185,6 +198,8 @@
 	# TODO don't store display-name in config file.
     }
 
+    $bar->finish() if not $opt_quiet;
+    
     close CONF or warn "cannot close $config_file: $!";
     say("Finished configuration.");
 
@@ -219,11 +234,11 @@
    });
 
 if ($opt_list_channels) {
-    my $bar = new Term::ProgressBar('getting list of channels', 1)
-      if Have_bar && not $opt_quiet;
+    my $bar = new XMLTV::ProgressBar('getting list of channels', 1)
+      if not $opt_quiet;
     my %channels = get_channels();
     die 'no channels could be found' if (scalar(keys(%channels)) == 0);
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
 
     foreach my $ch_did (sort(keys %channels)) {
 	my $ch_name = $channels{$ch_did};
@@ -231,6 +246,7 @@
 	$writer->write_channel({ id => $ch_xid,
 				 'display-name' => [ [ $ch_name ] ] });
     }
+    $bar->finish() if not $opt_quiet;
     $writer->end();
     exit();
 }
@@ -290,16 +306,17 @@
 
 my %warned_ch_name; # suppress duplicate warnings
 
-my $bar = new Term::ProgressBar('fetching data', scalar @to_get)
-  if Have_bar && not $opt_quiet;
+my $bar = new XMLTV::ProgressBar('fetching data', scalar @to_get)
+  if not $opt_quiet;
 my @to_get_detailed;
 my $num_detailed = 0;
 foreach (@to_get) {
     my ($url, $date, $ch_xmltv_id, $ch_tvgids_id) = @$_;
     t "going to get $ch_xmltv_id for $date";
     process_listings_page($writer, $ch_xmltv_id, $url, $date);
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
 }
+$bar->finish() if not $opt_quiet;
 $writer->end();
 
 ######################################################################
Index: grab/es/tv_grab_es
===================================================================
RCS file: /cvsroot/xmltv/xmltv/grab/es/tv_grab_es,v
retrieving revision 1.22
diff -u -B -b -w -r1.22 tv_grab_es
--- grab/es/tv_grab_es	1 Jan 2004 12:39:15 -0000	1.22
+++ grab/es/tv_grab_es	4 Feb 2004 17:47:16 -0000
@@ -10,7 +10,7 @@
 
 tv_grab_es --help
 
-tv_grab_es [--config-file FILE] --configure
+tv_grab_es [--config-file FILE] --configure [--gui OPTION]
 
 tv_grab_es [--config-file FILE] [--output FILE] [--days N]
            [--offset N] [--quiet]
@@ -38,6 +38,11 @@
 default is B<~/.xmltv/tv_grab_es.conf>.  This is the file written by
 B<--configure> and read when grabbing.
 
+B<--gui OPTION> Use this option to enable a graphical interface to be used.
+OPTION may be 'Tk' or 'GDialog', or left blank for the best available choice.
+Additional allowed values of OPTION are 'Term' for normal terminal output
+(default) and 'TermNoProgressBar' to disable the use of XMLTV::ProgressBar.
+
 B<--output FILE> write to FILE rather than standard output.
 
 B<--days N> grab N days.  The default is 3.
@@ -107,6 +112,8 @@
 
 use XMLTV;
 use XMLTV::Memoize;
+use XMLTV::GUI;
+use XMLTV::ProgressBar;
 use XMLTV::Ask;
 use XMLTV::Config_file;
 use XMLTV::Europe_TZ;
@@ -123,9 +130,6 @@
 END
   ;
 
-# Use Term::ProgressBar if installed.
-use constant Have_bar => eval { require Term::ProgressBar; 1 };
-
 # Attributes of the root element in output.
 my $HEAD = { 'source-info-url'     => 'http://www.elpais.es/parrillatv/portada.html',
 	     'source-data-url'     => "http://www.elpais.es/parrillatv/resultados.html",
@@ -148,8 +152,8 @@
 # Get options, including undocumented --cache option.
 XMLTV::Memoize::check_argv('XMLTV::Get_nice::get_nice_aux');
 my ($opt_days, $opt_offset, $opt_help, $opt_output,
-    $opt_configure, $opt_config_file, $opt_quiet,
-    $opt_list_channels);
+    $opt_configure, $opt_config_file, $opt_gui,
+    $opt_quiet, $opt_list_channels);
 $opt_days  = 3; # default
 $opt_offset = 0; # default
 $opt_quiet  = 0; # default
@@ -158,6 +162,7 @@
 	   'help'          => \$opt_help,
 	   'configure'     => \$opt_configure,
 	   'config-file=s' => \$opt_config_file,
+           'gui:s'         => \$opt_gui,
 	   'output=s'      => \$opt_output,
 	   'quiet'         => \$opt_quiet,
 	   'list-channels' => \$opt_list_channels
@@ -167,6 +172,12 @@
   if (defined $opt_days && $opt_days < 0);
 usage(1) if $opt_help;
 
+# Ask the XMLTV::GUI module for the graphics type we will use  
+my $gui_type = XMLTV::GUI::get_gui_type($opt_gui);
+
+XMLTV::Ask::init($gui_type);
+XMLTV::ProgressBar::init($gui_type);
+
 my $mode = XMLTV::Mode::mode('grab', # default
 			     $opt_configure => 'configure',
 			     $opt_list_channels => 'list-channels',
@@ -295,14 +306,15 @@
 # This progress bar is for both downloading and parsing.  Maybe
 # they could be separate.
 #
-my $bar = new Term::ProgressBar('getting listings', scalar @to_get)
-  if Have_bar && not $opt_quiet;
+my $bar = new XMLTV::ProgressBar('getting listings', scalar @to_get)
+  if not $opt_quiet;
 foreach (@to_get) {
 	foreach (process_table($_->[0], $_->[1], $_->[2])) {
 		$writer->write_programme($_);
 	}
-	update $bar if Have_bar && not $opt_quiet;
+	update $bar if not $opt_quiet;
 }
+$bar->finish() if not $opt_quiet;
 $writer->end();
 
 ######################################################################
@@ -492,8 +504,8 @@
 
 # get channel listing
 sub get_channels {
-    my $bar = new Term::ProgressBar('getting list of channels', 1)
-	if Have_bar && not $opt_quiet;
+    my $bar = new XMLTV::ProgressBar('getting list of channels', 1)
+	if not $opt_quiet;
     my %channels;
     my $url="http://www.elpais.es/parrillatv/portada.html";
     t $url;
@@ -528,7 +540,8 @@
 	}
     }
     die "no channels could be found" if not keys %channels;
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
+    $bar->finish() if not $opt_quiet;
     return %channels;
 }
 
Index: grab/fi/tv_grab_fi
===================================================================
RCS file: /cvsroot/xmltv/xmltv/grab/fi/tv_grab_fi,v
retrieving revision 1.30
diff -u -B -b -w -r1.30 tv_grab_fi
--- grab/fi/tv_grab_fi	1 Feb 2004 20:38:07 -0000	1.30
+++ grab/fi/tv_grab_fi	4 Feb 2004 17:47:17 -0000
@@ -10,7 +10,7 @@
 
 tv_grab_fi --help
 
-tv_grab_fi [--config-file FILE] --configure
+tv_grab_fi [--config-file FILE] --configure [--gui OPTION]
 
 tv_grab_fi [--config-file FILE] [--output FILE] [--days N]
            [--offset N] [--quiet]
@@ -35,6 +35,11 @@
 default is B<~/.xmltv/tv_grab_fi.conf>.  This is the file written by
 B<--configure> and read when grabbing.
 
+B<--gui OPTION> Use this option to enable a graphical interface to be used.
+OPTION may be 'Tk' or 'GDialog', or left blank for the best available choice.
+Additional allowed values of OPTION are 'Term' for normal terminal output
+(default) and 'TermNoProgressBar' to disable the use of XMLTV::ProgressBar.
+
 B<--output FILE> write to FILE rather than standard output.
 
 B<--days N> grab N days.  The default is ten.
@@ -77,6 +82,8 @@
 
 use XMLTV;
 use XMLTV::Memoize;
+use XMLTV::GUI;
+use XMLTV::ProgressBar;
 use XMLTV::Ask;
 use XMLTV::Config_file;
 use XMLTV::Europe_TZ;
@@ -93,9 +100,6 @@
 END
   ;
 
-# Use Term::ProgressBar if installed.
-use constant Have_bar => eval { require Term::ProgressBar; 1 };
-
 # Attributes of the root element in output.
 my $HEAD = { 'source-info-url'     => 'http://www.katso.fi/',
 	     'source-data-url'     => "http://www.katso.fi/tvopas",
@@ -122,8 +126,8 @@
 # Get options, including undocumented --cache option.
 XMLTV::Memoize::check_argv('XMLTV::Get_nice::get_nice_aux');
 my ($opt_days, $opt_offset, $opt_help, $opt_output,
-    $opt_configure, $opt_config_file, $opt_quiet,
-    $opt_list_channels);
+    $opt_configure, $opt_config_file, $opt_gui,
+    $opt_quiet, $opt_list_channels);
 $opt_days  = 10; # default
 $opt_offset = 0; # default
 $opt_quiet  = 0; # default
@@ -132,6 +136,7 @@
 	   'help'          => \$opt_help,
 	   'configure'     => \$opt_configure,
 	   'config-file=s' => \$opt_config_file,
+           'gui:s'         => \$opt_gui,
 	   'output=s'      => \$opt_output,
 	   'quiet'         => \$opt_quiet,
 	   'list-channels' => \$opt_list_channels,
@@ -141,6 +146,12 @@
   if (defined $opt_days && $opt_days < 0);
 usage(1) if $opt_help;
 
+# Ask the XMLTV::GUI module for the graphics type we will use  
+my $gui_type = XMLTV::GUI::get_gui_type($opt_gui);
+
+XMLTV::Ask::init($gui_type);
+XMLTV::ProgressBar::init($gui_type);
+
 my $mode = XMLTV::Mode::mode('grab', # default
 			     $opt_configure => 'configure',
 			     $opt_list_channels => 'list-channels',
@@ -266,14 +277,15 @@
 # This progress bar is for both downloading and parsing.  Maybe
 # they could be separate stages.
 #
-my $bar = new Term::ProgressBar('getting listings', scalar @to_get)
-  if Have_bar && not $opt_quiet;
+my $bar = new XMLTV::ProgressBar('getting listings', scalar @to_get)
+  if not $opt_quiet;
 foreach (@to_get) {
     foreach (process_table($_->[0], $_->[1], $_->[2])) {
 	$writer->write_programme($_);
     }
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
 }
+$bar->finish() if not $opt_quiet;
 $writer->end();
 
 ######################################################################
@@ -488,8 +500,8 @@
 
 # get channel listing
 sub get_channels {
-    my $bar = new Term::ProgressBar('getting list of channels', 1)
-      if Have_bar && not $opt_quiet;
+    my $bar = new XMLTV::ProgressBar('getting list of channels', 1)
+      if not $opt_quiet;
     my %channels;
     my $url="http://www.katso.fi/tvopas";
     my $local_data=get_nice($url);
@@ -531,7 +543,8 @@
 	}
     }
     die "no channels could be found" if not keys %channels;
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
+    $bar->finish() if not $opt_quiet;
     return %channels;
 }
 
Index: grab/hu/tv_grab_hu
===================================================================
RCS file: /cvsroot/xmltv/xmltv/grab/hu/tv_grab_hu,v
retrieving revision 1.12
diff -u -B -b -w -r1.12 tv_grab_hu
--- grab/hu/tv_grab_hu	1 Feb 2004 20:38:07 -0000	1.12
+++ grab/hu/tv_grab_hu	4 Feb 2004 17:47:17 -0000
@@ -10,7 +10,7 @@
 
 tv_grab_hu --help
 
-tv_grab_hu [--config-file FILE] --configure
+tv_grab_hu [--config-file FILE] --configure [--gui OPTION]
 
 tv_grab_hu [--config-file FILE] [--output FILE] [--days N]
            [--offset N] [--quiet]
@@ -33,6 +33,11 @@
 default is B<~/.xmltv/tv_grab_hu.conf>.  This is the file written by
 B<--configure> and read when grabbing.
 
+B<--gui OPTION> Use this option to enable a graphical interface to be used.
+OPTION may be 'Tk' or 'GDialog', or left blank for the best available choice.
+Additional allowed values of OPTION are 'Term' for normal terminal output
+(default) and 'TermNoProgressBar' to disable the use of XMLTV::ProgressBar.
+
 B<--output FILE> write to FILE rather than standard output.
 
 B<--days N> grab N days.  The default is eight.
@@ -76,6 +81,8 @@
 
 use XMLTV;
 use XMLTV::Memoize;
+use XMLTV::GUI;
+use XMLTV::ProgressBar;
 use XMLTV::Ask;
 use XMLTV::Europe_TZ;
 use XMLTV::Get_nice;
@@ -85,16 +92,13 @@
 # Todo: perhaps we should internationalize messages and docs?
 use XMLTV::Usage <<END
 $0: get Hungarian television listings in XMLTV format
-To configure: $0 --configure [--config-file FILE]
+To configure: $0 --configure [--config-file FILE] [--gui]
 To grab listings: $0 [--config-file FILE] [--output FILE] [--days N]
         [--offset N] [--quiet]
 To list channels: $0 --list-channels
 END
   ;
 
-# Use Term::ProgressBar if installed.
-use constant Have_bar => eval { require Term::ProgressBar; 1 };
-
 # Attributes of the root element in output.
 my $HEAD = { 'source-info-url'     => 'http://www.port.hu/',
 	     'source-data-url'     => "http://www.port.hu/tv/",
@@ -120,8 +124,8 @@
 # Get options, including undocumented --cache option.
 XMLTV::Memoize::check_argv('XMLTV::Get_nice::get_nice_aux');
 my ($opt_days, $opt_offset, $opt_help, $opt_output,
-    $opt_configure, $opt_config_file, $opt_quiet,
-    $opt_list_channels);
+    $opt_configure, $opt_config_file, $opt_gui,,
+    $opt_quiet, $opt_list_channels);
 $opt_days = 8; # default
 $opt_offset = 0; # default
 $opt_quiet = 0; # default
@@ -130,6 +134,7 @@
 	   'help'          => \$opt_help,
 	   'configure'     => \$opt_configure,
 	   'config-file=s' => \$opt_config_file,
+           'gui:s'         => \$opt_gui,
 	   'output=s'      => \$opt_output,
 	   'quiet'         => \$opt_quiet,
 	   'list-channels' => \$opt_list_channels,
@@ -138,6 +143,13 @@
 die 'number of days must not be negative'
   if (defined $opt_days && $opt_days < 0);
 usage(1) if $opt_help;
+
+# Ask the XMLTV::GUI module for the graphics type we will use  
+my $gui_type = XMLTV::GUI::get_gui_type($opt_gui);
+
+XMLTV::Ask::init($gui_type);
+XMLTV::ProgressBar::init($gui_type);
+
 my $mode = XMLTV::Mode::mode('grab', # default
 			     $opt_configure => 'configure',
 			     $opt_list_channels => 'list-channels',
@@ -265,8 +277,8 @@
 # This progress bar is for both downloading and parsing.  Maybe
 # they could be separate stages.
 #
-my $bar = new Term::ProgressBar('getting listings', @days * @channels)
-  if Have_bar && not $opt_quiet;
+my $bar = new XMLTV::ProgressBar('getting listings', @days * @channels)
+  if not $opt_quiet;
 foreach my $d (@days) {
     my ($day, $i) = @$d;
     my $some_success = 0;
@@ -274,13 +286,15 @@
 	my @ps = process_table($day, xid($ch_did), $ch_did, $i);
 	$some_success = 1 if @ps;
 	$writer->write_programme($_) foreach @ps;
-	update $bar if Have_bar && not $opt_quiet;
+	update $bar if not $opt_quiet;
     }
     if (@channels and not $some_success) {
 	warn "failed to get any listings for day $i, stopping\n";
 	last;
     }
+    
 }
+$bar->finish() if not $opt_quiet;
 $writer->end();
 
 ######################################################################
@@ -465,8 +479,8 @@
 
 # get channel listing
 sub get_channels {
-    my $bar = new Term::ProgressBar('getting list of channels', 1)
-	if Have_bar && not $opt_quiet;
+    my $bar = new XMLTV::ProgressBar('getting list of channels', 1)
+	if not $opt_quiet;
     my %channels;
     my $url="http://www.port.hu/pls/tv/tv.prog";
     my $local_data=get_nice($url);
@@ -502,7 +516,8 @@
 	}
     }
     die "no channels could be found" if not keys %channels;
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
+    $bar->finish() if not $opt_quiet;
     return %channels;
 }
 
Index: grab/it/tv_grab_it.in
===================================================================
RCS file: /cvsroot/xmltv/xmltv/grab/it/tv_grab_it.in,v
retrieving revision 1.23
diff -u -B -b -w -r1.23 tv_grab_it.in
--- grab/it/tv_grab_it.in	1 Feb 2004 20:38:07 -0000	1.23
+++ grab/it/tv_grab_it.in	4 Feb 2004 17:47:19 -0000
@@ -11,7 +11,7 @@
 
 tv_grab_it --help
 
-tv_grab_it [--config-file FILE] --configure
+tv_grab_it [--config-file FILE] --configure [--gui OPTION]
 
 tv_grab_it [--config-file FILE] [--output FILE] [--days N]
            [--offset N] [--quiet] [--slow]
@@ -33,6 +33,11 @@
 default is B<~/.xmltv/tv_grab_it.conf>.  This is the file written
 by B<--configure> and read when grabbing.
 
+B<--gui OPTION> Use this option to enable a graphical interface to be used.
+OPTION may be 'Tk' or 'GDialog', or left blank for the best available choice.
+Additional allowed values of OPTION are 'Term' for normal terminal output
+(default) and 'TermNoProgressBar' to disable the use of XMLTV::ProgressBar.
+
 B<--output FILE> write to FILE rather than standard output.
 
 B<--days N> grab N days.  The default is 7.
@@ -79,6 +84,8 @@
 use Memoize;
 use XMLTV;
 use XMLTV::Memoize;
+use XMLTV::GUI;
+use XMLTV::ProgressBar;
 use XMLTV::Ask;
 use XMLTV::Config_file;
 use XMLTV::Europe_TZ;
@@ -86,7 +93,7 @@
 # Todo: perhaps we should internationalize messages and docs?
 use XMLTV::Usage <<END
 $0: get Italian television listings in XMLTV format
-To configure: $0 --configure [--config-file FILE]
+To configure: $0 --configure [--config-file FILE] [--gui OPTION]
 To grab listings: $0 [--config-file FILE] [--output FILE] [--days N]
         [--offset N] [--quiet] [--slow]
 END
@@ -115,11 +122,6 @@
 my $base="http://$domain/canali.phtml";
 my $rturl="http://$domain/";
 
-######################################################################
-# Use Term::ProgressBar if installed.
-use constant Have_bar => eval { require Term::ProgressBar; 1 };
-
-######################################################################
 # get options
 # Get options, including undocumented --cache option.
 
@@ -135,6 +137,7 @@
     $opt_slow,
     $opt_configure,
     $opt_config_file,
+    $opt_gui,
     $opt_quiet,
     $opt_share,
    );
@@ -150,6 +153,7 @@
 	   'help'          => \$opt_help,
 	   'configure'     => \$opt_configure,
 	   'config-file=s' => \$opt_config_file,
+           'gui:s'         => \$opt_gui,
 	   'output=s'      => \$opt_output,
 	   'quiet'         => \$opt_quiet,
 	   'slow'	   => \$opt_slow,
@@ -160,6 +164,12 @@
   if (defined $opt_days && $opt_days < 0);
 usage(1) if $opt_help;
 
+# Ask the XMLTV::GUI module for the graphics type we will use  
+my $gui_type = XMLTV::GUI::get_gui_type($opt_gui);
+
+XMLTV::Ask::init($gui_type);
+XMLTV::ProgressBar::init($gui_type);
+
 # share/ directory for storing the list of dud channels.  This next line
 # is altered by processing through tv_grab_it.PL.  But we can use the
 # current directory instead of share/tv_grab_it for development.
@@ -206,11 +216,11 @@
 		}
     open(CONF, ">$config_file") or die "cannot write to $config_file: $!";
     # find list of available channels
-    my $bar = new Term::ProgressBar('getting list of channels', 1)
-      if Have_bar && not $opt_quiet;
+    my $bar = new XMLTV::ProgressBar('getting list of channels', 1)
+      if not $opt_quiet;
 	my %channels=get_channels_list($content);
     die "no channels could be found" if (scalar(keys(%channels))==0);
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
 
     # Ask about each channel.
     my @chs = sort keys %channels;
@@ -230,6 +240,7 @@
 	# TODO don't store display-name in config file.
     }
 
+    $bar->finish() if not $opt_quiet;
     close CONF or warn "cannot close $config_file: $!";
     say("Finished configuration.");
 
@@ -297,8 +308,8 @@
 }
 t "will get $days2get days from $opt_offset onwards";
 
-my $bar2 = new Term::ProgressBar('getting icons', scalar @channels)
-  if Have_bar && not $opt_quiet;
+my $bar2 = new XMLTV::ProgressBar('getting icons', scalar @channels)
+  if not $opt_quiet;
 foreach my $ch_id (@channels) {
     my $ch_xid=id_to_xid($ch_id);
 
@@ -316,11 +327,12 @@
 		       'display-name' => [ [ $channels{$ch_id} ] ],
 		       icon => [{src => get_icon($url)}]
 		      });
-    update $bar2 if Have_bar && not $opt_quiet;
+    update $bar2 if not $opt_quiet;
 }
+$bar2->finish() if not $opt_quiet;
 
-my $bar = new Term::ProgressBar('getting listings', scalar @to_get)
-  if Have_bar && not $opt_quiet;
+my $bar = new XMLTV::ProgressBar('getting listings', scalar @to_get)
+  if not $opt_quiet;
 foreach (@to_get) {
     my $canale= $_->[1];
     $url   = $_->[0];
@@ -347,9 +359,10 @@
 	$w->write_programme($_) foreach @dati;
     }
     #			else {warn "skipping $canale \n";}
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
 }
 $w->end;
+$bar->finish() if not $opt_quiet;
 
 ######################################################################
 # subroutines
Index: grab/na/tv_grab_na
===================================================================
RCS file: /cvsroot/xmltv/xmltv/grab/na/tv_grab_na,v
retrieving revision 1.97
diff -u -B -b -w -r1.97 tv_grab_na
--- grab/na/tv_grab_na	1 Jan 2004 12:31:03 -0000	1.97
+++ grab/na/tv_grab_na	4 Feb 2004 17:47:21 -0000
@@ -8,7 +8,7 @@
 
 =head1 SYNOPSIS
 
-tv_grab_na [--help] [--debug] [--config-file FILE] [--output FILE] --configure CONFIG_OPTIONS
+tv_grab_na [--help] [--debug] [--config-file FILE] [--output FILE] [--gui OPTION] --configure CONFIG_OPTIONS
 
 tv_grab_na [--help] [--debug] [--config-file FILE] [--output FILE] GRAB_OPTIONS
 
@@ -45,6 +45,11 @@
 written in configure mode and read in grab mode.  The default location
 is B<~/.xmltv/tv_grab_na.conf>.
 
+B<--gui OPTION> Use this option to enable a graphical interface to be used.
+OPTION may be 'Tk' or 'GDialog', or left blank for the best available choice.
+Additional allowed values of OPTION are 'Term' for normal terminal output
+(default) and 'TermNoProgressBar' to disable the use of Term::ProgressBar.
+
 B<--output FILE> Write output to FILE rather than standard output.
 
 Configuration is normally interactive, but it can be run
@@ -510,6 +515,8 @@
 use Date::Manip;
 
 use XMLTV::ZapListings;
+use XMLTV::GUI;
+use XMLTV::ProgressBar;
 use XMLTV::Ask;
 use XMLTV::Config_file;
 use XMLTV;
@@ -522,6 +529,15 @@
 
 our ($opt_debug, $opt_quiet, $opt_stats);
 
+sub termStatusMessage($)
+{
+    my $msg = shift;
+    die 'expected a message' if not defined $msg;
+    if ( !$opt_quiet ) {
+	print STDERR $msg;
+    }
+}
+
 sub statusMessage($)
 {
     my $msg = shift;
@@ -687,6 +703,9 @@
     print $fp "   --config-file <file>\n";
     print $fp "     use <file> as config file\n";
     print $fp "\n";
+    print $fp "   --gui <option>\n";
+    print $fp "     Use a GUI to ask questions\n";
+    print $fp "\n";
     print $fp "   --output <file>\n";
     print $fp "     redirect output to <file> rather than stdout. Currently only effects\n";
     print $fp "      --list-providers or --list-channels\n";
@@ -850,6 +869,7 @@
 	 $opt_zipcode,
 	 $opt_provider,
 	 $opt_config_file,
+         $opt_gui,
 	 $opt_output,
 	 $opt_retry_limit,
 	 $opt_retry_delay,
@@ -871,6 +891,7 @@
 			 quiet
 			 release-check=s
 			 config-file=s
+                         gui:s
 			 output=s
 			 postalcode=s
 			 zipcode=s
@@ -892,6 +913,12 @@
 
     checkCache(); # make sure $opt_cache is a dir or undef
 
+    # Ask the XMLTV::GUI module for the graphics type we will use  
+    my $gui_type = XMLTV::GUI::get_gui_type($opt_gui);
+
+    XMLTV::Ask::init($gui_type);
+    XMLTV::ProgressBar::init($gui_type);
+    
     $opt_release_check=($opt_release_check=~m;^t;i);
 
     $opt_quiet=(defined($opt_quiet));
@@ -1094,9 +1121,13 @@
 );
 
     if ( $opt_release_check ) {
-	statusMessage("checking XMLTV release information..\n");
+            
+        my $bar = new XMLTV::ProgressBar('checking XMLTV release information..', 1);
 
 	my $retval=XMLTV::ZapListings::getCurrentReleaseInfo($xmltvFreshmeatRecord, $opt_debug);
+        $bar->update();
+        $bar->finish();
+
 	if ( !defined($retval) ) {
 	    statusMessage( <<END
 Warning: failed to get current release information from:
@@ -1117,7 +1148,7 @@
 	}
     }
 
-    statusMessage("\nstarting manual configuration process..\n\n");
+    termStatusMessage("\nstarting manual configuration process..\n\n");
 
     while ( !defined($config->{option_retry_limit}) ) {
 	my $res=ask('how many times do you want to retry on www site failures ? (default=2)');
@@ -1181,7 +1212,7 @@
 	$code=$config->{option_postalcode} if ( defined($config->{option_postalcode}) );
 	$code=$config->{option_zipcode} if ( defined($config->{option_zipcode}) );
 
-	statusMessage("\ngetting list of providers for postal/zip code $code, be patient..\n");
+        my $bar = new XMLTV::ProgressBar("getting list of providers for postal/zip code $code, be patient..", 1);
 
 	my @providers;
 	my $failed=0;
@@ -1220,11 +1251,11 @@
 		if ( $p->{id} eq $config->{option_provider} ) {
 		    if ( $config->{option_provider_desc} ne $p->{description} ) {
 			if ( $opt_auto_fail_on_provider_changes ) {
-			    statusMessage("provider:\n\t".$config->{option_provider}." \# ".$config->{option_provider_desc}.
+			    termStatusMessage("provider:\n\t".$config->{option_provider}." \# ".$config->{option_provider_desc}.
 					  "\nhas new description (".$p->{description}."), exiting\n");
 			    exit(1);
 			}
-			statusMessage("updating provider description to: $p->{description}\n");
+			termStatusMessage("updating provider description to: $p->{description}\n");
 			$config->{option_provider_desc}=$p->{description};
 		    }
 		    $still_valid=1;
@@ -1244,7 +1275,7 @@
 				exit(1);
 			    }
 			}
-			statusMessage("updating provider id to: $p->{id}\n");
+			termStatusMessage("updating provider id to: $p->{id}\n");
 			$config->{option_provider}=$p->{id};
 			$still_valid=1;
 		    }
@@ -1271,6 +1302,9 @@
 	    }
 	}
 
+        $bar->update();
+        $bar->finish();
+        
 	while ( !$config->{option_provider} ) {
 	    my @providersWithIds;
 
@@ -1312,18 +1346,19 @@
 	    my $id = $1; die if not defined $id;
 	    $config->{option_provider}=$id;
 	    $config->{option_provider_desc}=$res;
-	    statusMessage("\nyou chose $id \# $res\n");
+	    termStatusMessage("\nyou chose $id \# $res\n");
 	}
     }
 
     # if we're in the configure step, lets refresh the list of channels
     # being careful to warn about additions and deletions
     
+    my $bar;
     if ( $config->haveAnyChannels() ) {
-	statusMessage("\nchecking for changes to channel list, be patient..\n");
+        $bar = new XMLTV::ProgressBar('checking for changes to channel list, be patient..', 1);
     }
     else {
-	statusMessage("\ngetting channel list, be patient..\n");
+        $bar = new XMLTV::ProgressBar('getting channel list, be patient..', 1);
     }
 
     my @channels;
@@ -1335,7 +1370,7 @@
 	}
 
 	@channels=$zl->getChannelList($config->{option_provider});
-	statusMessage("got channel list\n");
+	termStatusMessage("got channel list\n");
 	if ( ! @channels || !defined($channels[0]) ) {
 	    $failed=1;
 	}
@@ -1344,6 +1379,8 @@
 	    last;
 	}
     }
+    $bar->update();
+    $bar->finish();
 
     if ( $failed ) {
 	#errorMessage("$0: failed to get list of channels for postal/zip code $config->{option_postalzipcode}\n");
@@ -1371,11 +1408,11 @@
     if ( defined($opt_auto_new_channels) ) {
 	if ( $opt_auto_new_channels eq "ignore" ) {
 	    @r = map { 0 } @toAsk;
-	    statusMessage("ignoring new channel $_\n") foreach @toAsk;
+	    termStatusMessage("ignoring new channel $_\n") foreach @toAsk;
 	}
 	elsif ( $opt_auto_new_channels eq "add" ) {
 	    @r = map { 1 } @toAsk;
-	    statusMessage("adding new channel $_\n") foreach @toAsk;
+	    termStatusMessage("adding new channel $_\n") foreach @toAsk;
 	}
 	else {
 	    die "invalid auto_new_channels $opt_auto_new_channels\n";
@@ -1411,11 +1448,11 @@
     if ( defined($opt_auto_missing_channels) ) {
 	if ( $opt_auto_missing_channels eq "ignore" ) {
 	    @r = map { 0 } @toAsk;
-	    statusMessage("ignoring missing channel $_...\n") foreach @toAsk;
+	    termStatusMessage("ignoring missing channel $_...\n") foreach @toAsk;
 	}
 	elsif ( $opt_auto_missing_channels eq "remove" ) {
 	    @r = map { 1 } @toAsk;
-	    statusMessage("removing channel $_..\n") foreach @toAsk;
+	    termStatusMessage("removing channel $_..\n") foreach @toAsk;
 	}
 	else {
 	    die "invalid auto_missing_channels $opt_auto_missing_channels\n";
@@ -1438,15 +1475,15 @@
 
     if ( $channelsUpdated == 0 ) {
 	if ( $config->haveAnyChannels() ) {
-	    statusMessage("\nchannel line-up hasn't changed\n");
+	    termStatusMessage("\nchannel line-up hasn't changed\n");
 	}
 	else {
-	    statusMessage("\nno channels added\n");
+	    termStatusMessage("\nno channels added\n");
 	}
     } 
 
     # write out config file
-    statusMessage("\nupdating $configfile..\n");
+    termStatusMessage("\nupdating $configfile..\n");
     if ( $config->save($configfile) != 0 ) {
 	errorMessage("$0: $configfile save failed\n");
 	exit(1);
Index: grab/nl/tv_grab_nl.in
===================================================================
RCS file: /cvsroot/xmltv/xmltv/grab/nl/tv_grab_nl.in,v
retrieving revision 1.3
diff -u -B -b -w -r1.3 tv_grab_nl.in
--- grab/nl/tv_grab_nl.in	7 Jan 2004 19:55:26 -0000	1.3
+++ grab/nl/tv_grab_nl.in	4 Feb 2004 17:47:22 -0000
@@ -82,6 +82,8 @@
 use Date::Manip;
 use XMLTV;
 use XMLTV::Memoize;
+use XMLTV::GUI;
+use XMLTV::ProgressBar;
 use XMLTV::Ask;
 use XMLTV::Config_file;
 use XMLTV::Europe_TZ;
@@ -111,9 +113,6 @@
     }
 }
 
-# Use Term::ProgressBar if installed.
-use constant Have_bar => eval { require Term::ProgressBar; 1 };
-
 # Function prototypes.
 sub time_tot_str( $ );
 sub time_van_str( $ );
@@ -139,7 +138,7 @@
 # Get options, including undocumented --cache option.
 XMLTV::Memoize::check_argv('XMLTV::Get_nice::get_nice_aux');
 my ($opt_days, $opt_offset, $opt_help, $opt_output,
-    $opt_configure, $opt_config_file, $opt_quiet,
+    $opt_configure, $opt_config_file, $opt_gui, $opt_quiet,
     $opt_list_channels, $opt_slow, $opt_share);
 $opt_days   = 7; # default
 $opt_offset = 0; # default
@@ -148,6 +147,7 @@
 	   'help'          => \$opt_help,
 	   'configure'     => \$opt_configure,
 	   'config-file=s' => \$opt_config_file,
+           'gui:s'         => \$opt_gui,
 	   'output=s'      => \$opt_output,
 	   'quiet'         => \$opt_quiet,
 	   'slow'	   => \$opt_slow,
@@ -172,6 +172,12 @@
 my $OUR_SHARE_DIR = (defined $SHARE_DIR) ? "$SHARE_DIR/tv_grab_nl" : '.';
 (my $CHANNELS_FILE = "$OUR_SHARE_DIR/channels") =~ tr!/!/!s;
 
+# Ask the XMLTV::GUI module for the graphics type we will use  
+my $gui_type = XMLTV::GUI::get_gui_type($opt_gui);
+
+XMLTV::Ask::init($gui_type);
+XMLTV::ProgressBar::init($gui_type);
+
 my $mode = XMLTV::Mode::mode('grab', # default
 			     $opt_configure => 'configure',
 			     $opt_list_channels => 'list-channels',
@@ -189,11 +195,12 @@
     # configuring it's useful to download at least something as a
     # check that the site is reachable etc.
     #
-    my $bar = new Term::ProgressBar('getting list of channels', 1)
-      if Have_bar && not $opt_quiet;
+    my $bar = new XMLTV::ProgressBar('getting list of channels', 1)
+      if not $opt_quiet;
     my %channels = get_channels(1);
     die 'no channels could be found' if (scalar(keys(%channels)) == 0);
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
+    $bar->finish();
 
     # Ask about each channel.
     my @chs = sort { $a <=> $b } keys %channels;
@@ -246,15 +253,15 @@
    });
 
 if ($mode eq 'list-channels') {
-    my $bar = new Term::ProgressBar('getting list of channels', 1)
-      if Have_bar && not $opt_quiet;
+    my $bar = new XMLTV::ProgressBar('getting list of channels', 1)
+      if not $opt_quiet;
 
     # Don't do any page fetches - assume the contents of the channels
     # file has already been checked enough.
     #
     my %channels = get_channels(0);
     die 'no channels could be found' if (scalar(keys(%channels)) == 0);
-    update $bar if Have_bar && not $opt_quiet;
+    update $bar if not $opt_quiet;
 
     foreach my $ch_did (sort(keys %channels)) {
 	my $ch_name = $channels{$ch_did};
@@ -263,6 +270,7 @@
 				 'display-name' => [ [ $ch_name ] ] });
     }
     $writer->end();
+    $bar->finish();
     exit();
 }
 
@@ -335,16 +343,17 @@
 my %warned_ch_name; # suppress duplicate warnings
 
 my @summary_page_data;
-my $bar = new Term::ProgressBar('downloading summary', scalar @to_get)
-  if Have_bar && not $opt_quiet;
+my $bar = new XMLTV::ProgressBar('downloading summary', scalar @to_get)
+  if not $opt_quiet;
 foreach (@to_get) {
     my ($url, $day, $ch_xmltv_id, $ch_tvgids_id) = @$_;
     die if ref $url;
     push @summary_page_data,
       [ $url, $ch_xmltv_id,
 	[ process_summary_page($url, $day, $day, \$channels{$ch_tvgids_id}) ] ];
-    update $bar if Have_bar and not $opt_quiet;
+    update $bar if not $opt_quiet;
 }
+$bar->finish();
 
 # Now we've fetched the descriptions, we know the channel names.
 foreach $ch_did (@channels) {
@@ -467,8 +476,8 @@
 
 my @to_write;
 if ($opt_slow) {
-    $bar = new Term::ProgressBar('getting details', scalar @summary_programmes)
-      if Have_bar && not $opt_quiet;
+    $bar = new XMLTV::ProgressBar('getting details', scalar @summary_programmes)
+      if not $opt_quiet;
     foreach my $s (@summary_programmes) {
 	my $urls = delete $s->{url};
 	if (not defined $urls) {
@@ -563,6 +572,7 @@
 	push @to_write, $detailed;
 	update $bar if $bar;
     }
+    $bar->finish();
 }
 else {
     @to_write = @summary_programmes;
Index: grab/uk/tv_grab_uk.in
===================================================================
RCS file: /cvsroot/xmltv/xmltv/grab/uk/Attic/tv_grab_uk.in,v
retrieving revision 1.96
diff -u -B -b -w -r1.96 tv_grab_uk.in
--- grab/uk/tv_grab_uk.in	3 Jan 2004 14:37:43 -0000	1.96
+++ grab/uk/tv_grab_uk.in	4 Feb 2004 17:47:24 -0000
@@ -10,7 +10,7 @@
 
 tv_grab_uk --help
 
-tv_grab_uk [--config-file FILE] --configure
+tv_grab_uk [--config-file FILE] --configure [--gui OPTION]
 
 tv_grab_uk [--config-file FILE] [--output FILE] [--days N]
            [--offset N] [--quiet]
@@ -36,6 +36,11 @@
 default is B<~/.xmltv/tv_grab_uk.conf>.  This is the file written by
 B<--configure> and read when grabbing.
 
+B<--gui OPTION> Use this option to enable a graphical interface to be used.
+OPTION may be 'Tk' or 'GDialog', or left blank for the best available choice.
+Additional allowed values of OPTION are 'Term' for normal terminal output
+(default) and 'TermNoProgressBar' to disable the use of Term::ProgressBar.
+
 B<--output FILE> When grabbing, write output to FILE rather than
 standard output.
 
@@ -88,9 +93,6 @@
     }
 }
 
-# Use Term::ProgressBar if installed.
-use constant Have_bar => eval { require Term::ProgressBar; 1 };
-
 use XMLTV;
 # We modify the XMLTV module's tables to add a <distribution> element
 # to <channel>s.  We assume each channel has exactly one distribution
@@ -104,6 +106,8 @@
 
 use XMLTV::TZ qw(gettz tz_to_num);
 use XMLTV::Memoize;
+use XMLTV::GUI;
+use XMLTV::ProgressBar;
 use XMLTV::Ask;
 use XMLTV::Config_file;
 use XMLTV::Get_nice;
@@ -147,6 +151,7 @@
     $opt_share,
     $opt_configure,
     $opt_config_file,
+    $opt_gui,
     $opt_offset,
     $opt_quiet,
    );
@@ -157,6 +162,7 @@
 	   'help'          => \$opt_help,
 	   'configure'     => \$opt_configure,
 	   'config-file=s' => \$opt_config_file,
+           'gui:s'         => \$opt_gui,
 	   'output=s'      => \$opt_output,
 	   'share=s'       => \$opt_share, # undocumented
            'offset=i'      => \$opt_offset,
@@ -169,6 +175,12 @@
     usage(1);
 }
 
+# Ask the XMLTV::GUI module for the graphics type we will use  
+my $gui_type = XMLTV::GUI::get_gui_type($opt_gui);
+
+XMLTV::Ask::init($gui_type);
+XMLTV::ProgressBar::init($gui_type);
+
 # share/ directory for storing channel mapping files.  This next line
 # is altered by processing through tv_grab_uk.PL.  But we can use the
 # current directory instead of share/tv_grab_uk for development.
@@ -335,7 +347,7 @@
 	    my @k = sort keys %to_choose;
 	    my $default = $k[0];
 	    my $chosen = askQuestion('Package to add: ',
-				     $default, @k, $finished_option);
+				     $default, $finished_option, @k);
 	    last if $chosen eq $finished_option;
 
 	    # Now prompt about individual channels in this package.
@@ -578,8 +590,8 @@
         foreach (@urls_for_day) {
 	    $num_to_get += scalar @$_ if defined;
 	}
-        my $bar = new Term::ProgressBar('downloading listings', $num_to_get)
-	  if Have_bar && not $opt_quiet;
+        my $bar = new XMLTV::ProgressBar('downloading listings', $num_to_get)
+	  if not $opt_quiet;
 
       DAY: foreach my $day ($first_day..$last_day) {
 	    my (@success, @get_failed, @no_content);
@@ -595,7 +607,7 @@
 		else {
 		    push @success, [ $got, $_ ];
 		}
-		update $bar if Have_bar && not $opt_quiet;
+		update $bar if not $opt_quiet;
 	    }
 	    if (not @success) {
 		if (not @get_failed and not @no_content) {
@@ -633,13 +645,14 @@
 	    }
 	    push @to_parse, @success;
 	}
+        $bar->finish() if not $opt_quiet;
     }
     else {
 	warn "apparently nothing to download\n";
     }
 
-    my $bar = new Term::ProgressBar('parsing', scalar @to_parse)
-      if Have_bar && not $opt_quiet;
+    my $bar = new XMLTV::ProgressBar('parsing', scalar @to_parse)
+      if not $opt_quiet;
     my ($encoding, $credits, %ch, @prog_lists);
     my $w;
     my %written_xid;
@@ -771,11 +784,13 @@
 	}
 
 	push @prog_lists, $prog_list;
-	update $bar if Have_bar && not $opt_quiet;
+	update $bar if not $opt_quiet;
+        
     }
+    $bar->finish() if not $opt_quiet;
 
-    $bar = new Term::ProgressBar('writing', scalar @prog_lists)
-      if Have_bar && not $opt_quiet;
+    $bar = new XMLTV::ProgressBar('writing', scalar @prog_lists)
+      if not $opt_quiet;
     $w->write_channels(\%ch);
     foreach (@prog_lists) {
 	# Remove the occasional zero-length programmes which pop up.  NB
@@ -785,10 +800,11 @@
 #	fix_zero_length($_);
 
 	$w->write_programme($_) foreach @$_;
-	update $bar if Have_bar && not $opt_quiet;
+	update $bar if not $opt_quiet;
     }
 
     $w->end() if defined $w;
+    $bar->finish() if not $opt_quiet;
 }
 
 
@@ -1346,8 +1362,8 @@
     my %r;
     my $num_pages = scalar @pages;
     t "initializing progress bar with $num_pages items";
-    my $bar = new Term::ProgressBar($text, $num_pages)
-      if Have_bar && not $opt_quiet;
+    my $bar = new XMLTV::ProgressBar($text, $num_pages)
+      if not $opt_quiet;
 
     # FIXME currently multiple pages are not supported.
     my $max_at_once = 1;
@@ -1386,12 +1402,13 @@
 		die "really cannot fetch $url, giving up\n";
 	    }
 	}
-	update $bar if Have_bar && not $opt_quiet;
+	update $bar if not $opt_quiet;
 	foreach (@this_fetch) {
 	    die "page $_ requested twice" if defined $r{$_}->{content};
 	    $r{$_}->{content} = shift @got;
 	}
     }
+    $bar->finish() if not $opt_quiet;
     die if (keys %r) != $num_pages;
     return \%r;
 }
Index: grab/uk_rt/tv_grab_uk_rt.in
===================================================================
RCS file: /cvsroot/xmltv/xmltv/grab/uk_rt/tv_grab_uk_rt.in,v
retrieving revision 1.48
diff -u -B -b -w -r1.48 tv_grab_uk_rt.in
--- grab/uk_rt/tv_grab_uk_rt.in	1 Feb 2004 20:11:02 -0000	1.48
+++ grab/uk_rt/tv_grab_uk_rt.in	4 Feb 2004 17:47:26 -0000
@@ -82,6 +82,8 @@
 use Getopt::Long;
 use XMLTV;
 use XMLTV::Memoize;
+use XMLTV::GUI;
+use XMLTV::ProgressBar;
 use XMLTV::Ask;
 use XMLTV::Europe_TZ;
 use XMLTV::Config_file;
@@ -159,6 +161,7 @@
     $opt_share,
     $opt_configure,
     $opt_config_file,
+    $opt_gui,
     $opt_offset,
     $opt_quiet,
     $opt_slow,
@@ -171,6 +174,7 @@
 	   'help'          => \$opt_help,
 	   'configure'     => \$opt_configure,
 	   'config-file=s' => \$opt_config_file,
+           'gui:s'         => \$opt_gui,
 	   'output=s'      => \$opt_output,
 	   'share=s'       => \$opt_share, # also undocumented
            'offset=i'      => \$opt_offset,
@@ -184,6 +188,12 @@
     usage(1);
 }
 
+# Ask the XMLTV::GUI module for the graphics type we will use  
+my $gui_type = XMLTV::GUI::get_gui_type($opt_gui);
+
+XMLTV::Ask::init($gui_type);
+XMLTV::ProgressBar::init($gui_type);
+
 # Date::Manip has a bug where 'now' will be wrong if you change the
 # timezone.  It won't be correctly converted from the system timezone
 # to the new one.  So we call parse_date('today midnight') _before_
@@ -330,8 +340,11 @@
 	}
     }
     my $days = @dates_to_get > 1 ? 'days' : 'day';
-    say('getting ' . (scalar @dates_to_get) . " $days of listings\n")
+    
+    my $bar = new XMLTV::ProgressBar('getting ' . (scalar @dates_to_get)
+        . " $days of listings", 1)
       unless $opt_quiet;
+    
     t 'getting dates:' . d \@dates_to_get;
 
     $writer->start({ 'source-info-url'     => "$BASE_URL/",
@@ -439,6 +452,9 @@
 	  unless $seen{$_->{channel}}{$_->{start}}{$_->{stop} || ''}++;
     }
     $writer->end();
+    
+    $bar->finish();
+    
 }
 
 
@@ -1525,24 +1541,26 @@
 sub configure() {
 #    local $Log::TraceMessages::On = 1;
 
-    if (not askBooleanQuestion( <<END
-Warning: this grabber requires a large number of page fetches from a
-human-readable website.  It is normally better to run tv_grab_uk,
-which has its own data source.
-
-Proceed with configuration?
-END
-        , 0)) {
-	say("Exiting.\n");
-	exit 0;
-    }
+#    if (not askBooleanQuestion( <<END
+#Warning: this grabber requires a large number of page fetches from a
+#human-readable website.  It is normally better to run tv_grab_uk,
+#which has its own data source.
+
+#Proceed with configuration?
+#END
+#        , 0)) {
+#	say("Exiting.\n");
+#	exit 0;
+#    }
 
     XMLTV::Config_file::check_no_overwrite($config_file);
 
-    # FIXME turn into progress bar.
-    print STDERR "finding channels:\t";
+    my $bar = new XMLTV::ProgressBar('finding channels', 1)
+	  if not $opt_quiet;
+    
     my %channels = get_channels();
-    print STDERR "got ". (scalar keys %channels) . " done.\n" unless $opt_quiet;
+    
+    $bar->finish();
 
     # FIXME need to make directory
     open(CONF, ">$config_file") or die "cannot write to $config_file: $!";
Index: lib/Ask.pm
===================================================================
RCS file: /cvsroot/xmltv/xmltv/lib/Ask.pm,v
retrieving revision 1.12
diff -u -B -b -w -r1.12 Ask.pm
--- lib/Ask.pm	3 Jan 2004 14:52:53 -0000	1.12
+++ lib/Ask.pm	4 Feb 2004 17:47:26 -0000
@@ -7,9 +7,18 @@
 
 package XMLTV::Ask;
 use strict;
-use Carp qw(croak carp);
 
-# Use Log::TraceMessages if installed, and choose graphical or not.
+use vars qw(@ISA @EXPORT);
+use Exporter;
+@ISA = qw(Exporter);
+@EXPORT = qw(ask
+             askQuestion
+             askBooleanQuestion
+             askManyBooleanQuestions
+             say
+             );
+
+# Use Log::TraceMessages if installed.
 BEGIN {
     eval { require Log::TraceMessages };
     if ($@) {
@@ -21,21 +30,51 @@
 	*d = \&Log::TraceMessages::d;
     }
 
-    # For now we do graphical configuration only if the undocumented
-    # XMLTV_TK environment variable is set to a true value.
-    #
-    if ($ENV{XMLTV_TK}
-	and (defined($ENV{DISPLAY}) || $^O eq 'MSWin32')
-	and eval { require Tk }) {
-	require XMLTV::AskTk; XMLTV::AskTk->import;
-	*XMLTV::Ask:: = *XMLTV::AskTk::;
-    }
-    else {
-	require XMLTV::AskTerm; XMLTV::AskTerm->import;
-	*XMLTV::Ask:: = *XMLTV::AskTerm::;
+
+    
     }
+
+my $real_class = 'XMLTV::Ask::Term';
+
+sub AUTOLOAD {
+        
+        use vars qw($AUTOLOAD);
+        
+        (my $method_name = $AUTOLOAD) =~ s/.*::(.*?)/$1/;
+        
+        (my $real_class_path = $real_class.".pm") =~ s/::/\//g;
+        
+        require $real_class_path;
+        import $real_class_path;
+        
+        $real_class->$method_name(@_);
+        
 }
 
 
+# Must be called before we use this module if we want to use a gui.
+sub init( $ ) {
+        
+        my $gui_type = shift;
+        
+        if($gui_type =~ /^term/) {
+                
+                $real_class = 'XMLTV::Ask::Term';
+                
+        } elsif($gui_type eq 'tk') {
+                
+                $real_class = 'XMLTV::Ask::Tk';
+                
+        } elsif($gui_type eq 'gdialog') {
+                
+                $real_class = 'XMLTV::Ask::GDialog';
+                
+        } else {
+                
+                die "Unknown gui type: '$gui_type'.";
+                
+        }
+        
+}
 
 1;
